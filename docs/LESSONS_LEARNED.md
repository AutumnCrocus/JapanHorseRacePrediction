# 開発における教訓とトラブルシューティング (Lessons Learned)

## 2026-02-02: 2025年シミュレーション実装時のトラブル

### 1. Pandas `groupby` の挙動に関する誤解
*   **事象**: `df.groupby(level=0)` を使用した際、インデックスがユニークなID（`race_id`）だと思い込んでいたが、実際には`race_id`がインデックスに設定されていなかった、あるいは意図しないインデックス構造になっており、全行が個別のグループとして処理されてしまった。
*   **教訓**: `groupby` を使用する際は、インデックス(`level=...`)に頼らず、**明示的にカラム名(`by='race_id'`)を指定する**方が安全で可読性も高い。
*   **対策**: `df.groupby('race_id')` のようにカラム名を指定する。

### 2. Pandas データ型 (`dtypes`) の厳密な管理
*   **事象**: `model.predict` にデータを渡す際、一部のカラム（`枠番`, `馬番`など）が `object` 型のまま渡され、モデル（特にscikit-learn/LightGBM系）がエラー `pandas dtypes must be int, float or bool` を吐いた。
*   **原因**: データロード時やマージ時に型が `object` に推論されていた。また、前処理での型変換が漏れていた。
*   **教訓**: 予測直前（Just-In-Time）に、特徴量カラムに対して**強制的に数値変換を行う処理**を挟むのが最も確実である。
*   **対策**:
    ```python
    # 予測直前の安全策
    X = df[features].apply(pd.to_numeric, errors='coerce').fillna(0)
    preds = model.predict(X)
    ```

### 3. カラム名のタイポと空白文字
*   **事象**: `race_data['馬 番']` というように、カラム名に余計なスペースが含まれているコードが存在し、`KeyError` を引き起こした（エラーハンドリングで握りつぶされていたため発見が遅れた）。
*   **教訓**: 日本語カラム名は視認しづらいため、コピー＆ペーストを行うか、`df.columns` をプリントして確認する。また、エラーハンドリング (`try-except`) は、**開発中は具体的にエラー内容を標準出力/ログに出す**ようにする。
*   **対策**: `print(e)` だけでなく `traceback.print_exc()` を使う。カラム名は定数管理を検討する。

### 4. ログ出力の重要性
*   **事象**: スクリプトがエラーなく終了しているのに何も出力されない、あるいは結果が0になるケースがあった。
*   **教訓**:
    *   標準出力(`print`)はバッファリングされることがあるため、即時確認が必要な場合は `sys.stdout.flush()` するか `python -u` オプションを使用する。
    *   重要な分岐（ループの開始、予測の実行、的中判定のTrue分岐など）には必ずログを入れる。

