# Ranker Feature Matching Lessons

## 2026/02/20: LTRモデルの順位付け異常とその対策

### 事象

LTR（Learning to Rank）モデルをアプリにデプロイし、リアルタイム予測を行った際、予測順位が常に「馬番順」になってしまう。

### 原因

推論時に使用するデータが最新の「出馬表」のみに限定されており、モデルが学習時に重要視していた以下の特徴量がすべて `0`（デフォルト値）で埋められていた。

- 血統スコア (peds_score_speed, etc.)
- 過去成績の統計 (avg_rank, avg_last_3f, etc.)
- コース適性 (course_suitability)

これにより、モデルから見て全ての馬が同一条件（馬番以外の特徴が欠落）となり、同スコアとなった結果、内部的なソート順（馬番）で出力された。

### 教訓・対策

1. **特徴量の完全性の保証**:
    - 推論時にも学習時と同一のマスターデータ（過去成績、血統等）を引ける環境を構築すること。
    - 単純なスクレイピング結果だけでなく、バックグラウンドで管理している統計データとの結合を必須プロセスとする。
2. **ロード時の事前計算**:
    - 血統データなどの静的なマスターデータは、ロード時に事前計算（Pre-computation）しておくことで、リアルタイム推論時のCPU負荷を抑えつつ精度の高い特徴量を提供できる。
3. **デバッグスクリプトの活用**:
    - モデルデプロイ後、特定のレースに対して予測スコアが「分化（Differentiated）」しているかを確認する簡易スクリプトを走らせることで、この種の問題を早期発見できる。
