# Web Scraping & Automation Lessons

## 1. SPA(Riot.js)による動的レンダリングと待機処理 (2026-02-07)

* **事象**: IPAT画面に遷移後、直ちにボタン要素を探そうとすると `NoSuchElementException` が発生したり、空のリストが返ってくることがあった。
* **原因**: OreProの投票画面は Riot.js で構築されており、DOM構築が非同期で行われているため、Python側の `driver.get()` 完了時点では要素が存在しない場合がある。
* **教訓**: URL遷移やウィンドウ切り替え直後は、**対象となる具体的要素（例: `ul.Col4 li`）が表示されるまで `WebDriverWait` で明示的に待機する**。
* **対策**: `WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.CSS_SELECTOR, "ul.Col4 li")))`

## 2. 「流し」投票特有のDOM構造 (2026-02-07)

* **事象**: 「流し」の時だけチェックボックスのIDが異なり、要素を特定できなかった。
* **発見**: 流し投票時は以下のID規則でチェックボックスが生成されている。
  * **軸馬**: `id="uc-0-{馬番}"`
  * **相手馬**: `id="uc-1-{馬番}"`
* **教訓**: 投票方式によってDOM IDが変化するため、**方式ごとの専用ロジック（`select_horses_nagashi`）**を実装し、ID生成ルールを分離して管理すべき。

## 3. 金額入力の仕様（単価 vs 合計） (2026-02-07)

* **事象**: 自動投票スクリプトが「合計金額」を入力欄に入れ、過剰投票となってしまった。
* **原因**: IPATシステムは「**1点あたりの金額**（単価）」を要求するが、スクリプトは「合計予算」を入力していた。
* **教訓**: 特にBOXや流しなどの「多点買い」の場合は、**「合計予算 ÷ 組合せ点数」**の計算が必須となる。

## 4. 馬番のゼロ埋め（Leading Zero）問題 (2026-02-07)

* **事象**: 馬番 `04` をID `tr_04` として検索したが、実際のDOM IDは `tr_4` だった。
* **教訓**: Webサイト側のIDは数値（ゼロなし）である場合が多い。数字を扱う際は**一度 `int` に変換して正規化**してから文字列に戻して使用する。

## 5. HTMLの改行文字 (`\n`) の影響 (2026-02-13)

* **事象**: `yoso/mark_list.html` から単勝オッズを抽出する際、`\n` が含まれており完全一致判定が失敗した。
* **教訓**: Webスクレイピングにおいてタグ内のテキストを取得して比較する場合は、**常に `.strip()` で空白・改行を除去するか、部分一致 (`in`) または正規表現を使用する**。
