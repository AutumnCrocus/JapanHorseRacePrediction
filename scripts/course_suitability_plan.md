# コース適性特徴量の修正方針メモ

## 現在の問題
```python
# 全履歴を使用（未来データを含む）
hist_ranks = hist['rank_num'].values  # ❌
```

## 修正方針
1. `add_horse_history_features`と同様に、`_preprocess_horse_results`で日付前処理
2. ローリング平均+シフトを適用
3. ただし、コース適性は「距離別」「タイプ別」の勝率なので、expanding()だけでは不十分
4. 各レースについて、**それより前の該当条件（距離・タイプ）のレースのみ**を使用

## 実装の複雑さ
- 単純なexpanding()では不可（条件付き集計が必要）
- 馬ごと・レースごとにループが必要
- パフォーマンスへの影響大

## 暫定実装（Option A - 保守的）
1. まず`add_horse_history_features`と同じアプローチ
2. 各馬の「最新の統計値」を使用
3. 完璧ではないが、データリークは回避

## 完全実装（Option B - 理想）
1. 各レースについて、該当馬の過去履歴から該当条件のレースを抽出
2. 当該レースより前の条件一致レースのみで勝率を計算
3. 実装が複雑で、処理時間も長い

## 決定: Option Aで実装
理由:
- まず動作するものを作る
- 後で最適化できる
- 現在の全期間平均よりは大幅に改善
