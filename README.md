# 競馬予想AI

機械学習を活用した競馬予想システム。LightGBMモデルによる高精度な予測を提供します。

## 機能

- **データ収集**: netkeiba.comからレース結果、馬の成績、血統、払戻データをスクレイピング
- **機械学習予測**: LightGBMによる複勝確率予測
- **IPAT連携**: JRA即PATへの自動投票機能（実験的機能）
- **回収率シミュレーション**: 様々な賭け戦略のシミュレーション
- **Web UI**: レース予測結果をわかりやすく表示

## ディレクトリ構成

```
ネット競馬/
├── main.py              # CLIメインスクリプト
├── app.py               # Flask Webアプリケーション
├── requirements.txt     # Python依存パッケージ
├── modules/
│   ├── __init__.py
│   ├── constants.py     # 定数定義
│   ├── ipat_connector.py # IPAT連携モジュール
│   ├── scraping.py      # スクレイピングモジュール
│   ├── preprocessing.py # データ前処理
│   ├── training.py      # 機械学習モデル
│   └── simulation.py    # 回収率シミュレーション
├── static/
│   ├── css/
│   │   └── style.css
│   └── js/
│       └── app.js
├── templates/
│   └── index.html
├── data/                # データ保存ディレクトリ（自動生成）
│   ├── raw/
│   └── processed/
└── models/              # モデル保存ディレクトリ（自動生成）
```

## セットアップ

### 1. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

### 2. デモの実行（推奨）

```bash
python main.py demo
```

サンプルデータでモデルを作成し、予測結果を表示します。

## 使い方

### CLIモード

```bash
# データスクレイピング（時間がかかります）
python main.py scrape --year 2024 --sample

# モデル学習
python main.py train

# 予測実行
python main.py predict
```

### Webアプリモード

```bash
python app.py
```

http://localhost:5000 にアクセスしてWeb UIを使用。
IPAT連携機能を使用する場合は、予測結果画面から「IPATで馬券を購入」ボタンをクリックし、即PATの認証情報を入力してください。
※認証情報はブラウザ内に一時保存可能ですが、セキュリティ上の理由から保存しないことを推奨します。

## 戦略別パフォーマンス (2021-2025 バックテスト)

2010-2020年のデータで学習したモデルを使用し、未知の期間（2021-2025年）でシミュレーションした結果です。

| 戦略名 | 券種 | 買い方 | 回収率 | 備考 |
|:---|:---|:---|---:|:---|
| **box4_sanrenpuku** | 3連複 | AI上位4頭BOX (4点) | **327.5%** | ★推奨。全年度で240%超えの安定性。 |
| box4_umaren | 馬連 | AI上位4頭BOX (6点) | 199.3% | 3連複に次ぐ安定感。 |
| umaren_nagashi | 馬連 | 軸1頭流し (5点) | 213.9%* | 軸馬の選定精度に依存。 |
| wide_nagashi | ワイド | 軸1頭流し (5点) | 175.9%* | 的中率は高いが配当は控えめ。 |
| meta_contrarian | 3連複 | 5-7頭BOX等 | 171.9% | 爆発力あり。ただし2024-2025年は不調。 |

> ※ `*` : 5%サンプルでの検証値。他は10%サンプル。
> ※ 予算: 5,000円/レース。詳細は `simulation_report_historical_validation.md` 参照。

## モデルについて

### アルゴリズム
- **LightGBM**: 勾配ブースティング決定木を使用
- **目的変数**: 複勝（3着以内かどうかの二値分類）

### 主な特徴量
- 人気、単勝オッズ、斤量
- 馬の過去成績（平均着順、勝率、複勝率、出走回数）
- 騎手成績（平均着順、勝率）
- 性別、年齢、馬体重
- コース距離、コース種別

## 注意事項

⚠️ **免責事項**
- 本システムは予測を保証するものではありません
- 馬券購入は自己責任でお願いします
- netkeiba.comへのスクレイピングは適切な間隔を空けて行ってください
- **IPAT連携機能について**: 本機能は補助ツールであり、正常な投票を保証しません。必ず投票履歴をJRA公式サイトで確認してください。

## 参考

- [競馬予想で始める機械学習〜完全版〜](https://zenn.dev/dijzpeb/books/848d4d8e47001193f3fb)
